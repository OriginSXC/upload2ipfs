<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <title>Upload to IPFS by OriginSXC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="baidu-site-verification" content="codeva-xs5l6XyqbX" />
    <!-- Favicon / App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon.png">
    <link rel="manifest" href="assets/icons/site.webmanifest">
    <meta name="theme-color" content="#0f172a">    
    <meta name="description" content="Upload files to the IPFS network using this simple tool." />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    
    <!-- js-ipfs on CDN exposes global `Ipfs` in browsers; optional, used only for client-side CID fallback -->
    <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
        background-color: #2c3e50; /* Dark grayish blue */
        color: #bdc3c7; /* Light silver */
      }
      h1,
      h2 {
        margin-top: 0.33em;
        margin-bottom: 0.5em;
        text-align: center;
      }
      .alert {
        border: 3px dashed gold;
      }
      footer {
        text-align: center;
        padding: 1em 0;
      }
      .btn-copy {
        white-space: nowrap;
      }
      /* Ensure progress bar text is visible */
      .progress-bar {
        color: #fff;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }
    </style>
</head>
<body>
    <!-- Warning Modal -->
    <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel">Terms of Use</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Use for educational purposes only. Do not upload sensitive files, as
            it is possible for the gateway owner to view the files you upload,
            and it is not possible to remove the uploaded files using this tool.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" id="acceptBtn">
              Accept
            </button>
            <button type="button" class="btn btn-danger" id="declineBtn">
              Decline
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="errorModalBody">
            <!-- Error message will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container py-5">
      <h1>Upload files to IPFS</h1>

      <div class="row">
        <div class="col-md-6">
          <div class="progress my-2" style="height: 2rem;">
            <div id="download-progress" class="progress-bar bg-success fs-6" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
              Check download gateways
            </div>
          </div>
          <div class="d-grid gap-2">
            <button id="check-download-gateways" class="btn btn-primary btn-lg btn-block">
              Check & filter download gateways
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <div class="progress my-2" style="height: 2rem;">
            <div id="upload-progress" class="progress-bar bg-success fs-6" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
              Check upload gateways
            </div>
          </div>
          <div class="d-grid gap-2">
            <button id="check-upload-gateways" class="btn btn-primary btn-lg btn-block">
              Check & filter upload gateways
            </button>
          </div>
        </div>
      </div>

      <div class="text-center my-4">
        This will upload files to the <a href="https://ipfs.io">IPFS</a>
        network. You can hold <kbd>CTRL</kbd> while selecting files to upload
        multiple at once.
      </div>

      <div class="row">
        <div class="col-md-6">
          <label for="gateway-select" class="form-label">Select a gateway to view your uploaded files:</label>
          <select id="gateway-select" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label for="upload-gateway-select" class="form-label">Select a gateway to upload your files:</label>
          <select id="upload-gateway-select" class="form-select"></select>
        </div>
      </div>

      <form id="addForm" class="form my-3" method="post" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="file" class="form-label">Choose file(s):</label>
          <input type="file" class="form-control" name="file" id="file" multiple />
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-light" id="submit" style="display: none">Upload</button>
          <button class="btn btn-info btn-copy" id="copy-all-urls" type="button" style="display:none">Copy All URLs</button>
          <button class="btn btn-danger" id="cancel-upload" type="button" style="display:none">Cancel Upload</button>
        </div>
      </form>

      <div id="loading" class="alert alert-info" role="alert" style="display: none">
        Uploading...
      </div>

      <ul id="hashes" class="list-group my-3" style="display: none"></ul>

      <footer>
        Created by <a href="https://smitop.com" rel="noopener noreferrer" target="_blank">Smitop</a>, modified by
        <a href="https://github.com/OriginSXC/" rel="noopener noreferrer" target="_blank">OriginSXC</a>.
      </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      (function () {
        "use strict";

        // ====== Configuration ======
        const TIMEOUT_MS = 5000; // Timeout for gateway probes
        const CONCURRENCY = 8; // Maximum concurrent probes
        const SHOW_LATENCY_IN_OPTIONS = true; // Append "(X ms)" after gateway text

        // A known public CID to test download availability
        const TEST_CID = "bafybeifx7yeb55armcsxwwitkymga5xf53dxiarykms3ygqic223w5sk3m";

        // For endpoints with /api/v0/cat?arg= vs /ipfs/ we normalize per-gateway here
        const gatewayMatchingList = {
          "https://ipfs.network.thegraph.com/ipfs/api/v0/cat?arg=": "https://ipfs.network.thegraph.com/ipfs/api/v0/add?pin=true",
          "https://ipfs.gitcoin.co/api/v0/cat?arg=": "https://ipfs.gitcoin.co/api/v0/add?pin=true",
          "https://ipfs-2.gitcoin.co/api/v0/cat?arg=": "https://ipfs-2.gitcoin.co/api/v0/add?pin=true",
          "https://ipfs-3.gitcoin.co/api/v0/cat?arg=": "https://ipfs-3.gitcoin.co/api/v0/add?pin=true",
          "https://ipfs.treejer.com/ipfs/": "https://ipfs.treejer.com/api/v0/add?pin=true",
          "https://ipfs.oversas.org/ipfs/": "https://ipfs.oversas.org/api/v0/add?pin=true",
          "https://api.thegraph.com/ipfs/api/v0/cat?arg=": "https://api.thegraph.com/ipfs/api/v0/add?pin=true",
          "https://ipfs.questbook.app:8080/api/v0/cat?arg=": "https://ipfs.questbook.app/api/v0/add?pin=true",
          "https://gw-seattle.crustcloud.io/ipfs/": "https://gw-seattle.crustcloud.io:443/api/v0/add",
          "https://magic.decentralized-content.com/ipfs/": "https://ipfs-uploader.zora.co/api/v0/add",
          "https://ipfs.decentralized-content.com/ipfs/": "https://ipfs-uploader.zora.co/api/v0/add",
        };

        const downloadGateways = [
  "https://ipfs.eternum.io/ipfs/",
  "http://gateway.ipfs.io/ipfs/",
  "https://4everland.io/ipfs/",
  "https://api.thegraph.com/ipfs/api/v0/cat?arg=",
  "https://api.universalprofile.cloud/ipfs/",
  "https://aragon.ventures/ipfs/",
  "https://c4rex.co/ipfs/",
  "https://cdn.ipfsscan.io/ipfs/",
  "https://crustwebsites.net/ipfs/",
  "https://dweb.eu.org/ipfs/",
  "https://dweb.link/ipfs/",
  "https://fleek.cool/ipfs/",
  "https://gateway.serph.network/ipfs/",
  "https://gw-seattle.crustcloud.io/ipfs/",
  "https://gw.crustapps.net/ipfs/",
  "https://hashnews.k1ic.com/ipfs/",
  "https://hub.textile.io/ipfs/",
  "https://infura-ipfs.io/ipfs/",
  "https://ipfs.1-2.dev/ipfs/",
  "https://ipfs.algonode.dev/ipfs/",
  "https://ipfs.algonode.xyz/ipfs/",
  "https://ipfs.best-practice.se/ipfs/",
  "https://ipfs.cyou/ipfs/",
  "https://ipfs.decentralized-content.com/ipfs/",
  "https://ipfs.decoo.io/ipfs/",
  "https://ipfs.denarius.io/ipfs/",
  "https://ipfs.dlux.io/ipfs/",
  "https://ipfs.filebase.io/ipfs/",
  "https://ipfs.fleek.co/ipfs/",
  "https://ipfs.fooock.com/ipfs/",
  "https://ipfs.genenetwork.org/ipfs/",
  "https://ipfs-gateway.cloud/ipfs/",
  "https://ipfs.greyh.at/ipfs/",
  "https://ipfs.ink/ipfs/",
  "https://ipfs.io/ipfs/",
  "https://ipfs.jbb.one/ipfs/",
  "https://ipfs.kaleido.art/ipfs/",
  "https://ipfs.kavin.rocks/ipfs/",
  "https://ipfs.network.thegraph.com/ipfs/api/v0/cat?arg=",
  "https://ipfs.omniflix.studio/ipfs/",
  "https://ipfs.oversas.org/ipfs/",
  "https://ipfs.questbook.app:8080/api/v0/cat?arg=",
  "https://ipfs.runfission.com/ipfs/",
  "https://ipfs.stardustxr.org/ipfs/",
  "https://ipfs.treejer.com/ipfs/",
  "https://ipfs.trusti.id/ipfs/",
  "https://ipfsgateway.makersplace.com/ipfs/",
  "https://magic.decentralized-content.com/ipfs/",
  "https://ninetailed.ninja/ipfs/",
  "https://permaweb.eu.org/ipfs/",
  "https://permaweb.io/ipfs/",
  "https://storjipfs-gateway.com/ipfs/",
  "https://via0.com/ipfs/",
  "https://w3s.link/ipfs/"
];

        const uploadGateways = [
            "https://ipfs-uploader.zora.co/api/v0/add", "https://upload.ipfs.zora.co/api/v0/add", "https://ipfs.effect.ai/api/v0/add?pin=true", "https://unauthipfs.subquery.network/ipfs/api/v0/add?pin=true", "https://ipfs.gitcoin.co/api/v0/add?pin=true", "https://ipfs-2.gitcoin.co/api/v0/add?pin=true", "https://ipfs-3.gitcoin.co/api/v0/add?pin=true", "https://demo.storj-ipfs.com/api/v0/add", "https://ipfs.treejer.com/api/v0/add?pin=true", "https://ipfs.oversas.org/api/v0/add?pin=true", "https://api.thegraph.com/ipfs/api/v0/add?pin=true", "https://ipfs.network.thegraph.com/ipfs/api/v0/add?pin=true", "https://ipfs.questbook.app/api/v0/add?pin=true", "https://gw-seattle.crustcloud.io:443/api/v0/add"
        ];

        // ====== DOM Elements ======
        const downloadSelect = document.getElementById("gateway-select");
        const uploadSelect = document.getElementById("upload-gateway-select");
        const downloadProgress = document.getElementById("download-progress");
        const uploadProgress = document.getElementById("upload-progress");
        const submitBtn = document.getElementById("submit");
        const fileInput = document.getElementById("file");
        const hashesList = document.getElementById("hashes");
        const loadingAlert = document.getElementById("loading");
        const copyAllUrlsBtn = document.getElementById("copy-all-urls");
        const cancelUploadBtn = document.getElementById("cancel-upload");
        let errorModalInstance = null;
        let currentUploadRequest = null; // To hold the current XHR object

        // ====== Helper Functions ======

        function showError(message) {
            document.getElementById('errorModalBody').textContent = message;
            if (errorModalInstance) {
                errorModalInstance.show();
            }
        }
        
        function copyToClipboard(text, buttonElement) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = 0;
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                const originalText = buttonElement.textContent;
                if (successful) {
                    buttonElement.textContent = "Copied!";
                    setTimeout(() => { buttonElement.textContent = originalText; }, 1500);
                } else {
                    showError("Could not copy text. Please copy it manually.");
                }
            } catch (err) {
                showError("Could not copy text due to an error. Please copy it manually.");
                console.error('Copy to clipboard failed:', err);
            }
            document.body.removeChild(textArea);
        }

        function addOptionIfNotExists(selectElem, value, text) {
            const exists = Array.from(selectElem.options).some((o) => o.value === value);
            if (!exists) {
                const option = document.createElement("option");
                option.text = text;
                option.value = value;
                selectElem.add(option);
            }
        }

        function updateProgressBar(el, completed, working, total) {
            const pct = total === 0 ? 0 : Math.round((completed / total) * 100);
            el.style.width = pct + "%";
            el.setAttribute("aria-valuenow", String(pct));
            el.textContent = `${working} working / ${completed} tested / ${total} total`;
        }

        function normalizeDownloadUrl(base, cid) {
            if (base.includes("/api/v0/cat?")) return base + encodeURIComponent(cid);
            return base + cid;
        }

        function withTimeout(promise, ms, controller) {
            const t = setTimeout(() => controller.abort(), ms);
            return promise.finally(() => clearTimeout(t));
        }

        async function probeDownloadGateway(base, cid) {
            const controller = new AbortController();
            const url = normalizeDownloadUrl(base, cid);
            try {
                const res = await withTimeout(
                    fetch(url, { method: "HEAD", signal: controller.signal }),
                    TIMEOUT_MS,
                    controller
                );
                if (res.ok) return true;
                if (res.status === 405) throw new Error("HEAD not allowed, falling back to GET");
            } catch (_) {
                const controller2 = new AbortController();
                const res2 = await withTimeout(
                    fetch(url, { headers: { Range: "bytes=0-0" }, signal: controller2.signal }),
                    TIMEOUT_MS,
                    controller2
                ).catch(() => null);
                if (res2 && (res2.ok || res2.status === 206)) return true;
            }
            return false;
        }

        async function probeUploadGateway(url) {
            const fd = new FormData();
            const blob = new Blob(["test"], { type: "text/plain" });
            fd.append("file", blob, "test.txt");
            const controller = new AbortController();
            try {
                const res = await withTimeout(
                    fetch(url, { method: "POST", body: fd, signal: controller.signal }),
                    TIMEOUT_MS,
                    controller
                );
                return res.ok;
            } catch (_) {
                return false;
            }
        }

        async function checkGateways(gateways, selectElem, progressEl, isUpload = false) {
            const btn = progressEl.closest('.row').querySelector('button');
            btn.disabled = true;
            selectElem.innerHTML = "";
            const total = gateways.length;
            let completed = 0;
            let workingCount = 0;
            updateProgressBar(progressEl, 0, 0, total);

            const results = [];

            async function testOne(gw) {
                const start = performance.now();
                let ok = false;
                try {
                    ok = isUpload ? await probeUploadGateway(gw) : await probeDownloadGateway(gw, TEST_CID);
                } catch (e) {
                    // console.error(`Probe failed for ${gw}`, e);
                }
                const ms = Math.round(performance.now() - start);
                completed++;
                if (ok) {
                    workingCount++;
                    results.push({ gw, ms });
                }
                updateProgressBar(progressEl, completed, workingCount, total);
            }

            for (let i = 0; i < gateways.length; i += CONCURRENCY) {
                const chunk = gateways.slice(i, i + CONCURRENCY);
                await Promise.all(chunk.map(testOne));
            }

            results.sort((a, b) => a.ms - b.ms);

            selectElem.innerHTML = "";
            results.forEach(r => {
                const label = SHOW_LATENCY_IN_OPTIONS ? `${r.gw} (${r.ms} ms)` : r.gw;
                const option = document.createElement("option");
                option.value = r.gw;
                option.text = label;
                selectElem.add(option);
            });

            const key = isUpload ? "uploadGateways.filtered" : "downloadGateways.filtered";
            localStorage.setItem(key, JSON.stringify(results.map(r => r.gw)));
            btn.disabled = false;
        }

        function restoreSelectFromLocalStorage(selectElem, key, fallbackList) {
            try {
                const raw = localStorage.getItem(key);
                const list = raw ? JSON.parse(raw) : fallbackList;
                list.forEach((gw) => addOptionIfNotExists(selectElem, gw, gw));
            } catch (e) {
                console.error("Failed to restore from localStorage:", e);
                fallbackList.forEach((gw) => addOptionIfNotExists(selectElem, gw, gw));
            }
        }
        
        async function appendResultToUI(obj, file) {
            let hash = obj.Hash || obj.cid || null;
            let name = obj.Name || (file ? file.name : "unknown file");
            const size = obj.Size || obj.size || (file ? file.size : "");

            if (!hash && file) {
                hash = await generateCID(file);
            }

            if (!hash) return;

            const base = downloadSelect.value || downloadGateways[0];
            const url = normalizeDownloadUrl(base, hash);
            const paramConnector = url.includes("?") ? "&" : "?";
            const urlWithFilename = url + paramConnector + "filename=" + encodeURIComponent(name);

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            const a = document.createElement("a");
            a.href = urlWithFilename;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = `${hash} (${name}) - Size: ${size} bytes`;

            const copyBtn = document.createElement("button");
            copyBtn.className = "btn btn-sm btn-outline-secondary btn-copy";
            copyBtn.textContent = "Copy URL";
            copyBtn.addEventListener("click", () => copyToClipboard(urlWithFilename, copyBtn));

            li.appendChild(a);
            li.appendChild(copyBtn);
            hashesList.appendChild(li);
            
            copyAllUrlsBtn.style.display = 'inline-block';
        }

        function uploadSingleFile(file) {
            return new Promise((resolve, reject) => {
                const fd = new FormData();
                fd.append("file", file);

                const req = new XMLHttpRequest();
                currentUploadRequest = req; // Store the request object to be able to abort it
                const uploadUrl = uploadSelect.value;

                req.onerror = () => {
                    reject(new Error("Network error"));
                };
                
                req.onabort = () => {
                    reject(new Error("Upload aborted by user."));
                };

                req.onload = () => {
                    if (req.status >= 200 && req.status < 300) {
                        try {
                            const jsonResponse = JSON.parse(req.responseText);
                            resolve(jsonResponse);
                        } catch (e) {
                            reject(new Error("Invalid JSON response from gateway."));
                        }
                    } else {
                        reject(new Error(`Gateway returned status ${req.status}: ${req.statusText}`));
                    }
                };

                req.open("POST", uploadUrl);
                req.send(fd);
            });
        }

        async function submitForm(e) {
            e.preventDefault();
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                showError("Please select at least one file to upload.");
                return;
            }

            loadingAlert.style.display = "block";
            submitBtn.disabled = true;
            cancelUploadBtn.style.display = "inline-block"; // Show cancel button
            hashesList.style.display = "block";

            try {
                for (const file of files) {
                    try {
                        const response = await uploadSingleFile(file);
                        await appendResultToUI(response, file);
                    } catch (error) {
                        if (error.message.includes("aborted")) {
                            showError("Upload has been cancelled.");
                            break; // Exit the loop if cancelled
                        } else {
                            showError(`Upload failed for ${file.name}: ${error.message}`);
                        }
                    }
                }
            } finally {
                // This block ensures the UI is cleaned up regardless of success, failure, or cancellation
                loadingAlert.style.display = "none";
                submitBtn.disabled = false;
                cancelUploadBtn.style.display = "none"; // Hide cancel button
                currentUploadRequest = null; // Clear the request object
                fileInput.value = "";
                submitBtn.style.display = 'none';
            }
        }

        // ====== Init ======
        window.addEventListener("load", function () {
            errorModalInstance = new bootstrap.Modal(document.getElementById('errorModal'));
            
            if (!localStorage.getItem("termsAccepted")) {
                const warningModal = new bootstrap.Modal(document.getElementById("warningModal"), {
                    backdrop: "static",
                    keyboard: false
                });
                warningModal.show();
                document.getElementById("acceptBtn").addEventListener("click", function () {
                    localStorage.setItem("termsAccepted", "true");
                    warningModal.hide();
                });
                document.getElementById("declineBtn").addEventListener("click", function () {
                    window.location.href = "about:blank";
                });
            }

            restoreSelectFromLocalStorage(downloadSelect, "downloadGateways.filtered", downloadGateways);
            restoreSelectFromLocalStorage(uploadSelect, "uploadGateways.filtered", uploadGateways);

            downloadSelect.addEventListener("change", () => {
                localStorage.setItem("downloadGateways.last", downloadSelect.value);
                const match = gatewayMatchingList[downloadSelect.value];
                if (match) uploadSelect.value = match;
            });
            uploadSelect.addEventListener("change", () => {
                localStorage.setItem("uploadGateways.last", uploadSelect.value);
            });

            const lastDL = localStorage.getItem("downloadGateways.last");
            if (lastDL) downloadSelect.value = lastDL;
            const lastUL = localStorage.getItem("uploadGateways.last");
            if (lastUL) uploadSelect.value = lastUL;

            fileInput.addEventListener("change", function () {
                submitBtn.style.display = this.files && this.files.length > 0 ? "inline-block" : "none";
            });

            document.getElementById("check-download-gateways").addEventListener("click", () =>
                checkGateways(downloadGateways, downloadSelect, downloadProgress, false)
            );
            document.getElementById("check-upload-gateways").addEventListener("click", () =>
                checkGateways(uploadGateways, uploadSelect, uploadProgress, true)
            );

            document.getElementById("submit").addEventListener("click", submitForm);

            cancelUploadBtn.addEventListener("click", () => {
                if (currentUploadRequest) {
                    currentUploadRequest.abort();
                }
            });

            copyAllUrlsBtn.addEventListener("click", () => {
                const links = hashesList.querySelectorAll("a");
                if (links.length === 0) return;
                const urls = Array.from(links).map(a => a.href).join("\n");
                copyToClipboard(urls, copyAllUrlsBtn);
            });
        });
      })();
    </script>
  </body>
</html>
